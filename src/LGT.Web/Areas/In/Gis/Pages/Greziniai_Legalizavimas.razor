@page "/in/gis/grezinys/legalizavimas"
@attribute [CustomAuthorize(GISEnum.Greziniai_tikstatistika)]

@code {

  private DateTime? Since { get; set; } = new DateTime(2023, 02, 01, 00, 00, 00);
  private DateTime? Until { get; set; } = new DateTime(2023, 02, 28, 23, 59, 59);
}
<table class="bord">
  <tr>
    <td colspan="2">
      Laikotarpis
    </td>
  </tr>
  <tr>
    <td>Nuo</td>
    <td><LGT.Web.Shared.Inputs.BindDateTime @bind-value=@Since ParamFormat="yyyy-MM-dd HH:mm" /></td>
  </tr>
  <tr>
    <td>Iki</td>
    <td><LGT.Web.Shared.Inputs.BindDateTime @bind-value=@Until ParamFormat="yyyy-MM-dd HH:mm" /></td>
  </tr>
  <tr>
    <td>
      <button @onclick=@Skaiciuoti>Skaičiuoti</button>
    </td>
  </tr>
  @if(legalizuotiCount != null && normalCount != null)
  {
    <tr>
      <td>Legalizuoti</td>
      <td>@legalizuotiCount</td>
    </tr>
    <tr>
      <td>Standartiniai</td>
      <td>@normalCount</td>
    </tr>
    <tr>
      <td>viso</td>
      <td>@(normalCount + legalizuotiCount)</td>
    </tr>
  }
</table>

@inject LGT.Data.GeolisContext db
@code
{
  private int? legalizuotiCount;
  private int? normalCount;

  private async Task Skaiciuoti()
  {
    this.legalizuotiCount = null;
    normalCount = null;
    this.StateHasChanged();
    var x = await db.Greziniai.Where(item =>
      item.IregistravimoData != null
      && item.IregistravimoData.Value >= Since
      && item.IregistravimoData.Value <= Until
    )
      .GroupBy(item => item.GR_LEGALIZUOTAS == "T")
      .Select(item => new {
        Legalizuotas = item.Key,
        Count = item.Count()
      })
      .ToListAsync();
    legalizuotiCount = x.FirstOrDefault(item => item.Legalizuotas)?.Count ?? 0;
    normalCount = x.FirstOrDefault(item => !item.Legalizuotas)?.Count ?? 0;
  }
}
